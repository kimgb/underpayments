= form_for([@claim, @claim_company], html: { class: "form", multipart: true }) do |f|
  = render partial: "layouts/errors", locals: { resource: @claim_company }

  %fieldset
    %legend= t('views.companies.form.title')
    
    .checkbox
      = f.label :is_workplace do
        = f.check_box :is_workplace
        = "This company is my workplace"
    .checkbox
      = f.label :is_employer do
        = f.check_box :is_employer
        = "This company is my employer"
        
  %fieldset#search_company
    %legend.h4= t('views.companies.form.search')
    .form-group
      -# = f.label :company_id, t('views.companies.form.search'), class: "control-label"
      = f.select :company_id, options_for_select([["Start typing...", ""]]), {}, { class: "form-control" }
      %small.text-right
        Can't find it?
        %a.manipulator{ data: { show: "#manual_entry", hide: "#search_company" } } Enter it yourself
    
  %fieldset.collapse#manual_entry
    %legend.h4= t('views.companies.form.manual')
    = f.fields_for(:company) do |fc|
      .form-group
        = fc.label :name, t('views.companies.form.name'), class: "control-label"
        %br/
        -# = fc.select :name, options_for_select([@claim_company.company.name]), {}, { class: "form-control" }
        = fc.text_field :name, class: "form-control"
        %small.text-right
          %a.manipulator{ data: { show: "#search_company", hide: "#manual_entry" } } Search instead?
        
      .form-group
        = fc.label :contact, t('views.companies.form.contact'), class: "control-label"
        %br/
        = fc.text_field :contact, class: "form-control"
        .text-right
          %small= "E.g. your supervisor"

      .form-group
        = fc.label :abn, t('views.companies.form.abn'), class: "control-label"
        %br/
        = fc.text_field :abn, class: "form-control"
        .text-right
          %small
            Not sure? You can try looking it up
            %a{ href: "http://abr.business.gov.au/", target: "_blank" }here
            
      .form-group
        = fc.label :phone, t('views.companies.form.phone'), class: "control-label"
        %br/
        .input-group
          .input-group-addon
            %i.glyphicon.glyphicon-earphone
          = fc.telephone_field :phone, class: "form-control"

      .form-group
        = fc.label :email, t('views.companies.form.email'), class: "control-label"
        %br/
        .input-group
          .input-group-addon @
          = fc.email_field :email, class: "form-control"

  .actions.text-right= f.submit t('views.companies.form.commit'), class: "btn btn-default"
  
:javascript
  $("a.manipulator").on("click", function(e){
    $(e.target.dataset.hide).slideUp(800);
    $(e.target.dataset.show).delay(800).slideDown(800);
  })

  $("#claim_company_company_id").select2({
    theme: "bootstrap",
    ajax: {
      url: "#{companies_path}.json",
      dataType: "json",
      type: "GET",
      quietMillis: 50,
      delay: 250,
      data: function(params){
        return { name: params.term };
      },
      processResults: function(data, params){
        return {
          results: $.map(data, function(item){
            if (item.address){
              var addr = item.address.town + ", " + item.address.province + " " + item.address.postal_code;
            } else {
              var addr = "no address";
            }
          
            return { 
              text: item.name + " (" + addr + ")",
              id: item.id
            }
          })
        };
      },
      cache: true
    },
    escapeMarkup: function(markup){ return markup; },
    minimumInputLength: 3
  });

  //Selectize version, mostly functional
  //$("#claim_company_company_id").selectize({
  //  loadThrottle: 250,
  //  valueField: 'id',
  //  labelField: 'name',
  //  searchField: 'name',
  //  render: {
  //    option: function(item, escape){
  //      if (item.address){
  //        var addr = item.address.town + ", " + item.address.province + " " + item.address.postal_code;
  //      } else {
  //        var addr = "no address";
  //      }
  //      
  //      return '<div><span>' + escape(item.name) + ' (' + escape(addr) + ')' + '</span></div>';
  //    }
  //  },
  //  load: function(query, callback){
  //    if (query.length < 3) return callback();
  //    $.ajax({
  //      url: "#{companies_path}.json",
  //      dataType: "json",
  //      type: "GET",
  //      data: {
  //        name: query
  //      },
  //      error: function() {
  //        callback();
  //      },
  //      success: function(res) {
  //        callback(res);
  //      }
  //    })
  //  }
  //})
